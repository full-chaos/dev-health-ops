networks:
  dev-health:
    external: true
    name: dev-health-network

services:
  api:
    build:
      context: .
      dockerfile: ./docker/Dockerfile
      target: api
      args:
        SETUPTOOLS_SCM_PRETEND_VERSION: ${VERSION:-0.0.0}
    container_name: dev-health-api
    restart: unless-stopped
    networks:
      - dev-health
    command: >
      --db "${DATABASE_URI:-clickhouse://ch:ch@dev-health-clickhouse:8123/default}"
      --host 0.0.0.0
      --port 8000
      --reload
    environment:
      DATABASE_URI: ${DATABASE_URI:-clickhouse://ch:ch@dev-health-clickhouse:8123/default}
      POSTGRES_URI: ${POSTGRES_URI:-postgresql+asyncpg://postgres:postgres@dev-health-postgres:5432/devhealth}
      REDIS_URL: ${REDIS_URL:-redis://dev-health-redis:6379/1}
      CELERY_BROKER_URL: ${CELERY_BROKER_URL:-redis://dev-health-redis:6379/0}
      GRAPHQL_QUERY_TIMEOUT: ${GRAPHQL_QUERY_TIMEOUT:-30}
      SETUPTOOLS_SCM_PRETEND_VERSION_FOR_DEV_HEALTH_OPS: ${VERSION:-0.0.0}
    ports:
      - "${API_PORT:-8000}:8000"
    volumes:
      - ./:/app
    working_dir: /app
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 30s

  worker:
    build:
      context: .
      dockerfile: ./docker/Dockerfile
      target: api
      args:
        SETUPTOOLS_SCM_PRETEND_VERSION: ${VERSION:-0.0.0}
    container_name: dev-health-worker
    restart: unless-stopped
    networks:
      - dev-health
    command: celery -A workers.celery_app worker --loglevel=info -Q default,metrics,sync
    environment:
      DATABASE_URI: ${DATABASE_URI:-clickhouse://ch:ch@dev-health-clickhouse:8123/default}
      POSTGRES_URI: ${POSTGRES_URI:-postgresql+asyncpg://postgres:postgres@dev-health-postgres:5432/devhealth}
      CELERY_BROKER_URL: ${CELERY_BROKER_URL:-redis://dev-health-redis:6379/0}
      CELERY_RESULT_BACKEND: ${CELERY_RESULT_BACKEND:-redis://dev-health-redis:6379/0}
      SETUPTOOLS_SCM_PRETEND_VERSION_FOR_DEV_HEALTH_OPS: ${VERSION:-0.0.0}
    volumes:
      - ./:/app
    working_dir: /app
    profiles:
      - worker
